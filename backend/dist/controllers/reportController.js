"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.exportAssignmentsPDF = exports.exportTransfersExcel = exports.exportPurchasesPDF = void 0;
const pdfkit_1 = __importDefault(require("pdfkit"));
const exceljs_1 = __importDefault(require("exceljs"));
const db_1 = require("../db");
// Helper to format date
const formatDate = (date) => {
    return new Date(date).toLocaleDateString();
};
// Export Purchases to PDF
const exportPurchasesPDF = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const user = req.user;
        const { baseId, fromDate, toDate } = req.query;
        const where = {};
        if (user.role !== "ADMIN") {
            where.baseId = user.baseId;
        }
        else if (baseId) {
            where.baseId = baseId;
        }
        if (fromDate || toDate) {
            where.date = {};
            if (fromDate)
                where.date.gte = fromDate;
            if (toDate)
                where.date.lte = toDate;
        }
        const purchases = yield db_1.prisma.purchase.findMany({
            where,
            include: {
                base: true,
                equipment: true,
                user: true,
            },
            orderBy: { date: "desc" },
        });
        const doc = new pdfkit_1.default({ margin: 50 });
        // Set response headers
        res.setHeader("Content-Type", "application/pdf");
        res.setHeader("Content-Disposition", "attachment; filename=purchases_report.pdf");
        doc.pipe(res);
        // Header
        doc.fontSize(20).text("Military Asset Management System", { align: "center" });
        doc.fontSize(16).text("Purchases Report", { align: "center" });
        doc.moveDown();
        doc.fontSize(10).text(`Generated on: ${new Date().toLocaleString()}`, { align: "right" });
        doc.text(`Generated by: ${user.email}`, { align: "right" });
        doc.moveDown();
        // Table Header
        const tableTop = 150;
        doc.fontSize(10).font("Helvetica-Bold");
        doc.text("Date", 50, tableTop);
        doc.text("Equipment", 120, tableTop);
        doc.text("Quantity", 250, tableTop);
        doc.text("Base", 320, tableTop);
        doc.text("User", 450, tableTop);
        doc.moveTo(50, tableTop + 15).lineTo(550, tableTop + 15).stroke();
        // Table Rows
        let y = tableTop + 25;
        doc.font("Helvetica");
        purchases.forEach((p) => {
            if (y > 700) {
                doc.addPage();
                y = 50;
            }
            doc.text(formatDate(p.date), 50, y);
            doc.text(p.equipment.name, 120, y);
            doc.text(p.quantity.toString(), 250, y);
            doc.text(p.base.name, 320, y);
            doc.text(p.user.email, 450, y, { width: 100 });
            y += 20;
        });
        doc.end();
    }
    catch (error) {
        console.error("PDF Export Error:", error);
        res.status(500).json({ error: "Failed to generate PDF report" });
    }
});
exports.exportPurchasesPDF = exportPurchasesPDF;
// Export Transfers to Excel
const exportTransfersExcel = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const user = req.user;
        const { baseId, fromDate, toDate } = req.query;
        const where = {};
        if (user.role !== "ADMIN") {
            where.OR = [
                { fromBaseId: user.baseId },
                { toBaseId: user.baseId }
            ];
        }
        else if (baseId) {
            where.OR = [
                { fromBaseId: baseId },
                { toBaseId: baseId }
            ];
        }
        if (fromDate || toDate) {
            where.date = {};
            if (fromDate)
                where.date.gte = fromDate;
            if (toDate)
                where.date.lte = toDate;
        }
        const transfers = yield db_1.prisma.transfer.findMany({
            where,
            include: {
                fromBase: true,
                toBase: true,
                equipment: true,
            },
            orderBy: { date: "desc" },
        });
        const workbook = new exceljs_1.default.Workbook();
        const worksheet = workbook.addWorksheet("Transfers");
        worksheet.columns = [
            { header: "Date", key: "date", width: 15 },
            { header: "Equipment", key: "equipment", width: 20 },
            { header: "Quantity", key: "quantity", width: 10 },
            { header: "From Base", key: "fromBase", width: 20 },
            { header: "To Base", key: "toBase", width: 20 },
            { header: "Status", key: "status", width: 15 },
        ];
        transfers.forEach((t) => {
            worksheet.addRow({
                date: formatDate(t.date),
                equipment: t.equipment.name,
                quantity: t.quantity,
                fromBase: t.fromBase.name,
                toBase: t.toBase.name,
                status: t.status,
            });
        });
        // Style header
        worksheet.getRow(1).font = { bold: true };
        res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        res.setHeader("Content-Disposition", "attachment; filename=transfers_report.xlsx");
        yield workbook.xlsx.write(res);
        res.end();
    }
    catch (error) {
        console.error("Excel Export Error:", error);
        res.status(500).json({ error: "Failed to generate Excel report" });
    }
});
exports.exportTransfersExcel = exportTransfersExcel;
// Export Assignments to PDF
const exportAssignmentsPDF = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const user = req.user;
        const { baseId, fromDate, toDate } = req.query;
        const where = {};
        if (user.role !== "ADMIN") {
            where.baseId = user.baseId;
        }
        else if (baseId) {
            where.baseId = baseId;
        }
        if (fromDate || toDate) {
            where.date = {};
            if (fromDate)
                where.date.gte = fromDate;
            if (toDate)
                where.date.lte = toDate;
        }
        const assignments = yield db_1.prisma.assignment.findMany({
            where,
            include: {
                base: true,
                equipment: true,
                user: true,
            },
            orderBy: { date: "desc" },
        });
        const doc = new pdfkit_1.default({ margin: 50 });
        res.setHeader("Content-Type", "application/pdf");
        res.setHeader("Content-Disposition", "attachment; filename=assignments_report.pdf");
        doc.pipe(res);
        doc.fontSize(20).text("Military Asset Management System", { align: "center" });
        doc.fontSize(16).text("Assignments & Expenditures Report", { align: "center" });
        doc.moveDown();
        doc.fontSize(10).text(`Generated on: ${new Date().toLocaleString()}`, { align: "right" });
        doc.moveDown();
        const tableTop = 150;
        doc.fontSize(10).font("Helvetica-Bold");
        doc.text("Date", 50, tableTop);
        doc.text("Type", 110, tableTop);
        doc.text("Equipment", 180, tableTop);
        doc.text("Qty", 280, tableTop);
        doc.text("Personnel/Reason", 320, tableTop);
        doc.text("Base", 480, tableTop);
        doc.moveTo(50, tableTop + 15).lineTo(550, tableTop + 15).stroke();
        let y = tableTop + 25;
        doc.font("Helvetica");
        assignments.forEach((a) => {
            var _a;
            if (y > 700) {
                doc.addPage();
                y = 50;
            }
            doc.text(formatDate(a.date), 50, y);
            doc.text(a.type, 110, y);
            doc.text(a.equipment.name, 180, y);
            doc.text(a.quantity.toString(), 280, y);
            doc.text(a.personnelName || a.reason || "—", 320, y, { width: 150 });
            doc.text(((_a = a.base) === null || _a === void 0 ? void 0 : _a.name) || "—", 480, y);
            y += 20;
        });
        doc.end();
    }
    catch (error) {
        console.error("PDF Export Error:", error);
        res.status(500).json({ error: "Failed to generate PDF report" });
    }
});
exports.exportAssignmentsPDF = exportAssignmentsPDF;
